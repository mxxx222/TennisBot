name: ğŸ”’ Security Validation & Deployment

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Daily security check at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  security-validation:
    name: ğŸ›¡ï¸ Security Validation
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: ğŸ”’ Security Validation
        run: |
          echo "Running comprehensive security validation..."
          python security_manager.py --validate
          echo "Security validation completed successfully"
          
      - name: ğŸ“Š Generate Security Report
        run: |
          python security_manager.py --report > security_report.md
          echo "Security report generated"
          
      - name: ğŸ“¤ Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security_report.md
          
  secret-validation:
    name: ğŸ” Secret Validation
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”’ Validate GitHub Secrets
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          API_FOOTBALL_KEY: ${{ secrets.API_FOOTBALL_KEY }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        run: |
          echo "Validating GitHub repository secrets..."
          python -c "
          import os
          secrets = ['TELEGRAM_BOT_TOKEN', 'API_FOOTBALL_KEY', 'SECRET_KEY']
          for secret in secrets:
              if os.environ.get(secret):
                  print(f'âœ… {secret} is configured')
              else:
                  print(f'âš ï¸  {secret} is not configured')
          "
          
  code-quality:
    name: ğŸ“‹ Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install black flake8 mypy
          
      - name: ğŸ” Code Quality (Black)
        run: black --check --diff .
        
      - name: ğŸ” Code Quality (Flake8)
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        
      - name: ğŸ” Code Quality (MyPy)
        run: mypy . --ignore-missing-imports